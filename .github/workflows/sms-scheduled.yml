```yaml
name: SMS Gateway Health Check

on:
  schedule:
    - cron: '0 6 * * *'    # هر روز ساعت ۶ صبح UTC (9:30 به وقت ایران)
  workflow_dispatch:         # اجرای دستی هم ممکن است

jobs:
  health-check:
    name: بررسی سلامت سرویس
    runs-on: ubuntu-latest

    steps:
      - name: ESB — UserInfo
        id: esb_health
        run: |
          RESPONSE=$(curl -sk --max-time 10 \
            -H "Authorization: Basic ${{ secrets.SMS_ESB_AUTH }}" \
            https://sms.persiafava.com:3006/UserInfo)
          STATUS=$(echo $RESPONSE | python3 -c "import sys,json; print(json.load(sys.stdin).get('status','error'))" 2>/dev/null || echo "parse_error")
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          if [ "$STATUS" != "0" ]; then
            echo "ESB health check FAILED: $STATUS"
            exit 1
          fi
          CASH=$(echo $RESPONSE | python3 -c "import sys,json; print(json.load(sys.stdin)['userInfo']['Cash'])")
          echo "ESB OK. Balance: $CASH ریال"

          # هشدار موجودی کم
          if python3 -c "import sys; exit(0 if $CASH > 10000000 else 1)"; then
            echo "Balance OK"
          else
            echo "::warning::موجودی حساب کم است: $CASH ریال"
          fi

      - name: REST — user_info
        id: rest_health
        run: |
          RESPONSE=$(curl -sk --max-time 10 \
            "http://sms.persiafava.com/webservice/rest/user_info?api_key=${{ secrets.SMS_API_KEY }}")
          RESULT=$(echo $RESPONSE | python3 -c "import sys,json; print(json.load(sys.stdin).get('result',''))" 2>/dev/null || echo "error")
          echo "result=$RESULT" >> $GITHUB_OUTPUT
          if [ "$RESULT" != "True" ] && [ "$RESULT" != "true" ]; then
            echo "REST health check FAILED"
            exit 1
          fi
          echo "REST OK"

      - name: ارسال نتیجه به Slack (اختیاری)
        if: failure() && secrets.SLACK_WEBHOOK != ''
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
            -H 'Content-Type: application/json' \
            -d '{"text": "هشدار: وب‌سرویس پرشیا فاوا در بررسی روزانه با مشکل مواجه شد."}'
```

---

## مرحله ۴ — راه‌اندازی Newman (تست Postman در CI)

Newman ابزار CLI برای اجرای Postman Collection است.

```yaml
name: Postman Collection Tests

on:
  push:
    branches: [main]
  pull_request:

jobs:
  newman:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: نصب Newman
        run: npm install -g newman

      - name: ساخت فایل environment
        run: |
          cat > postman-env.json << EOF
          {
            "id": "ci-env",
            "name": "CI Environment",
            "values": [
              {"key": "api_key",          "value": "${{ secrets.SMS_API_KEY }}", "enabled": true},
              {"key": "esb_auth",         "value": "${{ secrets.SMS_ESB_AUTH }}", "enabled": true},
              {"key": "sender_number",    "value": "${{ secrets.SMS_SENDER }}", "enabled": true},
              {"key": "recipient_number", "value": "${{ secrets.SMS_TEST_RECIPIENT }}", "enabled": true},
              {"key": "rest_base_url",    "value": "http://sms.persiafava.com/webservice/rest", "enabled": true},
              {"key": "esb_base_url",     "value": "https://sms.persiafava.com", "enabled": true},
              {"key": "dargah",           "value": "3000", "enabled": true},
              {"key": "last_smsid",       "value": "", "enabled": true},
              {"key": "last_smsids",      "value": "[]", "enabled": true},
              {"key": "last_received_id", "value": "0", "enabled": true}
            ]
          }
          EOF

      - name: اجرای collection (فقط health check requests)
        run: |
          newman run docs/PersiaFava_SMS_Gateway.postman_collection.json \
            --environment postman-env.json \
            --folder "وب‌سرویس REST" \
            --item "اطلاعات کاربر (user_info)" \
            --reporters cli,json \
            --reporter-json-export newman-results.json \
            --timeout-request 15000

      - name: آپلود نتایج
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: newman-results
          path: newman-results.json
```
