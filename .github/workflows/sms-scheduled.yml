```yaml
name: SMS Gateway Health Check

on:
  schedule:
    - cron: '0 6 * * *'    # هر روز ساعت ۶ صبح UTC (9:30 به وقت ایران)
  workflow_dispatch:         # اجرای دستی هم ممکن است

jobs:
  health-check:
    name: بررسی سلامت سرویس
    runs-on: ubuntu-latest

    steps:
      - name: ESB — UserInfo
        id: esb_health
        run: |
          RESPONSE=$(curl -sk --max-time 10 \
            -H "Authorization: Basic ${{ secrets.SMS_ESB_AUTH }}" \
            https://sms.persiafava.com:3006/UserInfo)
          STATUS=$(echo $RESPONSE | python3 -c "import sys,json; print(json.load(sys.stdin).get('status','error'))" 2>/dev/null || echo "parse_error")
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          if [ "$STATUS" != "0" ]; then
            echo "ESB health check FAILED: $STATUS"
            exit 1
          fi
          CASH=$(echo $RESPONSE | python3 -c "import sys,json; print(json.load(sys.stdin)['userInfo']['Cash'])")
          echo "ESB OK. Balance: $CASH ریال"

          # هشدار موجودی کم
          if python3 -c "import sys; exit(0 if $CASH > 10000000 else 1)"; then
            echo "Balance OK"
          else
            echo "::warning::موجودی حساب کم است: $CASH ریال"
          fi

      - name: REST — user_info
        id: rest_health
        run: |
          RESPONSE=$(curl -sk --max-time 10 \
            "http://sms.persiafava.com/webservice/rest/user_info?api_key=${{ secrets.SMS_API_KEY }}")
          RESULT=$(echo $RESPONSE | python3 -c "import sys,json; print(json.load(sys.stdin).get('result',''))" 2>/dev/null || echo "error")
          echo "result=$RESULT" >> $GITHUB_OUTPUT
          if [ "$RESULT" != "True" ] && [ "$RESULT" != "true" ]; then
            echo "REST health check FAILED"
            exit 1
          fi
          echo "REST OK"

      - name: ارسال نتیجه به Slack (اختیاری)
        if: failure() && secrets.SLACK_WEBHOOK != ''
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
            -H 'Content-Type: application/json' \
            -d '{"text": "هشدار: وب‌سرویس پرشیا فاوا در بررسی روزانه با مشکل مواجه شد."}'
```
